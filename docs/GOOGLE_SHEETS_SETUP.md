# Googleスプレッドシート連携セットアップガイド

## 🎯 概要

Discord BotをGoogleスプレッドシートと連携させることで、以下の機能が利用できます：

- Discord上で追加したタスクがGoogleスプレッドシートに自動同期
- スプレッドシート上でのタスク管理
- チームでのタスク共有・編集

## 🔧 セットアップ手順

### 1. Google Cloud Console設定

#### 1.1 プロジェクト作成
1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成（または既存プロジェクトを選択）

#### 1.2 Sheets API有効化
1. 「APIとサービス」→「ライブラリ」に移動
2. "Google Sheets API" を検索
3. 「有効にする」をクリック

#### 1.3 認証情報作成
1. 「APIとサービス」→「認証情報」に移動
2. 「認証情報を作成」→「OAuth 2.0 クライアントID」を選択
3. アプリケーションの種類：「デスクトップアプリケーション」
4. 名前を入力（例：Discord Bot Sheets）
5. 「作成」をクリック
6. JSONファイルをダウンロード

### 2. Googleスプレッドシート準備

#### 2.1 スプレッドシート作成
1. [Google Sheets](https://sheets.google.com/) にアクセス
2. 新しいスプレッドシートを作成
3. シート名を「Tasks」に変更（または任意の名前）
4. スプレッドシートのURLからIDを取得
   - URL: `https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`
   - `SPREADSHEET_ID` の部分をコピー

#### 2.2 共有設定（オプション）
チームで使用する場合は、適切な権限でスプレッドシートを共有してください。

### 3. プロジェクト設定

#### 3.1 認証情報ファイル配置
1. ダウンロードしたJSONファイルを `credentials.json` にリネーム
2. プロジェクトのルートディレクトリに配置

```
discord-bot/
├── credentials.json  ← ここに配置
├── app/
├── data/
└── ...
```

#### 3.2 環境変数設定
`.env` ファイルに以下を追加：

```env
# Google Sheets API連携
GOOGLE_CREDENTIALS_PATH=credentials.json
GOOGLE_SPREADSHEET_ID=your_spreadsheet_id_here
GOOGLE_SHEET_NAME=Tasks
```

**設定項目:**
- `GOOGLE_CREDENTIALS_PATH`: 認証情報ファイルのパス
- `GOOGLE_SPREADSHEET_ID`: スプレッドシートのID（必須）
- `GOOGLE_SHEET_NAME`: シート名（デフォルト: Tasks）

### 4. 初回認証

#### 4.1 ローカル環境での認証
1. Botを起動
2. `/task_sync` コマンドを実行
3. 認証が必要な場合、コンソールにURLが表示される
4. ブラウザでURLにアクセスし、Googleアカウントで認証
5. 認証コードをコピーしてコンソールに入力

#### 4.2 スプレッドシート初期化
初回実行時に、スプレッドシートに以下のヘッダー行が自動作成されます：

| ID | タイトル | 説明 | 期限 | 優先度 | ステータス | 作成者 | 作成日時 | 完了日時 |
|----|----------|------|------|--------|------------|--------|----------|----------|

## 🚀 使用方法

### 基本的な使い方

```bash
# タスク追加（Googleスプレッドシートに自動同期）
/task_add レポート作成 2025-01-20 high 月次売上レポート

# タスク一覧表示（Googleスプレッドシートから取得）
/task_list pending

# タスク完了（スプレッドシートで更新）
/task_complete 1

# 同期状態確認
/task_sync
```

### 連携状態の確認

`/task_sync` コマンドで現在の連携状態を確認できます：

- ✅ **連携中**: Googleスプレッドシートと正常に連携
- ⚠️ **認証エラー**: 認証情報に問題あり
- 📋 **ローカルモード**: Googleスプレッドシート連携無効

## 📊 スプレッドシートでの管理

### 列の説明

- **ID**: タスクの一意識別子（自動生成）
- **タイトル**: タスクのタイトル
- **説明**: タスクの詳細説明
- **期限**: 期限日（YYYY-MM-DD形式）
- **優先度**: high/medium/low
- **ステータス**: pending/completed
- **作成者**: Discord ユーザーID
- **作成日時**: タスク作成日時
- **完了日時**: タスク完了日時

### 手動編集

スプレッドシート上で直接編集することも可能ですが、以下に注意してください：

- **ID列は変更しない**: タスクの識別に使用
- **ステータス**: pending/completed のみ使用
- **優先度**: high/medium/low のみ使用
- **日付形式**: YYYY-MM-DD形式を維持

## 🔒 セキュリティ

### 認証情報の管理

**重要**: 以下のファイルは機密情報を含むため、適切に管理してください：

- `credentials.json` - OAuth 2.0 クライアント情報
- `data/sheets_token.json` - アクセストークン（自動生成）

### .gitignore設定

```gitignore
# Google Sheets認証情報
credentials.json
data/sheets_token.json
```

## 🔧 トラブルシューティング

### よくある問題

**Q: 認証エラーが発生する**
A: 以下を確認してください：
- `credentials.json` が正しい場所に配置されているか
- Google Cloud ConsoleでSheets APIが有効になっているか
- OAuth 2.0 クライアントIDが正しく設定されているか

**Q: スプレッドシートが見つからない**
A: 以下を確認してください：
- `GOOGLE_SPREADSHEET_ID` が正しく設定されているか
- スプレッドシートが存在し、アクセス権限があるか
- シート名が正しく設定されているか

**Q: タスクが同期されない**
A: 以下を確認してください：
- `/task_sync` で連携状態を確認
- 認証トークンが有効か（期限切れの場合は再認証）
- スプレッドシートの権限設定

**Q: 本番環境で認証できない**
A: 本番環境では対話的な認証ができないため、ローカルで認証を完了してから `data/sheets_token.json` をアップロードしてください。

### ログ確認

```bash
# デバッグモードでの実行
uvicorn server:app --host 0.0.0.0 --port 8080 --log-level debug
```

## 📊 機能制限

### 現在の制限事項

- タスクの編集機能は未実装（完了/削除のみ）
- 複数シートの同時管理は未対応
- 大量データでのパフォーマンス最適化は未実装

### 将来の拡張予定

- タスク編集機能
- 複数シート対応
- バッチ処理機能
- データ同期の最適化
- 権限管理機能

## 📞 サポート

問題が解決しない場合は、以下の情報と共にGitHubのIssuesで報告してください：

- エラーメッセージ
- 実行環境（ローカル/本番）
- 設定ファイルの内容（機密情報は除く）
- 実行したコマンド
- スプレッドシートの設定状況